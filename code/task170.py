def p(m,p=enumerate):
 t,u=min((t,u)for t,i in p(m)for u,i in p(i)if len(f:={*sum((i[u:u+3]for i in m[t:t+3]),[])})>1>(0in f));a,*d=3+(m[t][u+3]>0),
 for i in m[t:t+a]:d+=[i[u:u+a]];i[u:u+a]=[0]*a
 f=len(m:=[[i[0]for i in zip(i,*m)if any(i)]for i in m if any(i)]);a=f//a;return[[i*(m[a*t][a*u]>0)for u,i in p(i)]for t,i in p(d)]