def p(f,p=enumerate):
 i,y=min((i,y)for i,a in p(f)for y,a in p(a)if len(s:={*sum((a[y:y+3]for a in f[i:i+3]),[])})>1>(0in s));u,*l=3+(f[i][y+3]>0),
 for a in f[i:i+u]:l+=[a[y:y+u]];a[y:y+u]=[0]*u
 f=len(o:=[[a[0]for a in zip(a,*f)if any(a)]for a in f if any(a)]);f=f//u;return[[a*(o[f*i][f*y]>0)for y,a in p(a)]for i,a in p(l)]