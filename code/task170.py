def p(f,p=enumerate):
 h,e=min((h,e)for h,s in p(f)for e,s in p(s)if len(o:={*sum((s[e:e+3]for s in f[h:h+3]),[])})>1>(0in o));n,*l=3+(f[h][e+3]>0),
 for s in f[h:h+n]:l+=[s[e:e+n]];s[e:e+n]=[0]*n
 f=len(o:=[[s[0]for s in zip(s,*f)if any(s)]for s in f if any(s)]);f=f//n;return[[s*(o[f*h][f*e]>0)for e,s in p(s)]for h,s in p(l)]