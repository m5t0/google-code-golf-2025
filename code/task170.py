def p(t,p=enumerate):
 r,i=min((r,i)for r,a in p(t)for i,a in p(a)if len(f:={*sum((a[i:i+3]for a in t[r:r+3]),[])})>1>(0in f));m,*u=3+(t[r][i+3]>0),
 for a in t[r:r+m]:u+=[a[i:i+m]];a[i:i+m]=[0]*m
 f=len(o:=[[a[0]for a in zip(a,*t)if any(a)]for a in t if any(a)]);m=f//m;return[[a*(o[m*r][m*i]>0)for i,a in p(a)]for r,a in p(u)]